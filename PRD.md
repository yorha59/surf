# Surf 项目需求文档 (PRD)

> 说明：本 PRD 仅用于描述产品需求和验收标准，不再承载各开发工作区的具体实现细节、代码路径或测试日志。实现层面的说明（例如 `impl_notes` / `remaining_todos` 等），请在对应工作区（如 `workspaces/dev-core-scanner/`、`workspaces/dev-cli-tui/`、`workspaces/dev-service-api/` 等）的文档或注释中维护；本文件中已有的此类段落视为历史记录，后续不再扩写。

## 1. 项目概览
**项目名称**: Surf
**目标**: 为 Linux 和 macOS 系统提供一个极速、美观且功能强大的磁盘扫描与分析工具。
**核心价值**: 帮助用户快速定位磁盘占用大户，支持多维度可视化分析，并提供清理建议。

### 1.1 范围（Scope）
- 支持对本地文件系统的只读扫描与分析，不修改文件内容本身（删除能力作为单独操作能力提供）。
- 覆盖四种主要形态：CLI、TUI、JSON-RPC 服务模式以及 macOS GUI；核心扫描与分析能力在各形态之间保持一致。
- 面向单机环境的磁盘空间分析；云存储、远程文件系统等能力仅作为未来规划的一部分。

### 1.2 非目标（Out of Scope）
- 当前版本不支持 Windows 平台。
- 当前版本不提供自动化清理策略（仅给出清理建议），自动清理归入“未来规划”。
- 不替代系统级安全/备份方案，用户删除文件前需自行确认影响范围。

## 2. 目标用户
*   **开发者**: 需要分析代码库、依赖项或构建产物占用的磁盘空间。
*   **系统管理员**: 需要快速排查服务器磁盘满额问题。
*   **普通高级用户**: 想要管理个人电脑存储空间。

## 3. 功能需求

### 3.1 核心扫描功能
*   **并发控制**: 支持通过 `--threads` (或 `-t`) 参数指定扫描线程数。默认利用所有逻辑 CPU 核心以达到最高 IO 效率。
*   **扫描过滤**: 
    *   支持 `--min-size` 指定最小过滤大小（如 `100MB`）。
    *   支持过滤掉小于设定阈值的所有文件。

### 3.2 运行模式

#### 3.2.1 单次运行模式 (One-off)
*   **交互逻辑**:
    1.  **执行中**: 终端显示动态进度条（推荐使用 `indicatif` 库），实时反馈已处理文件数和总容量。
    2.  **完成后**: 进度条自动结束，并在其下方**默认以格式化表格形式打印最终结果**。
*   **结果展示**:
    *   **排序**: 强制按文件大小降序排列。
    *   **条数限制**: 支持 `--limit` (或 `-n`) 参数控制展示的最大条目数。例如 `--limit 20` 只显示前 20 个最大的文件。

#### 3.2.2 服务模式 (Service Mode)
*   **功能描述**: 启动 JSON-RPC 服务，允许其他应用（如 GUI 程序）通过网络连接进行磁盘扫描和分析。
*   **配置选项**: 
    *   支持 `--service` (或 `-s`) 参数启动服务模式。
    *   支持 `--port` 参数指定服务监听端口（默认 1234）。
    *   支持 `--host` 参数指定服务监听地址（默认 127.0.0.1）。

#### 3.2.3 图形界面模式 (GUI Mode - macOS)

**1. 初始安装引导 (Onboarding):**
*   **初次运行检测**: 应用程序启动时检测是否存在配置文件。若不存在，进入引导流程。
*   **引导步骤**:
    *   **欢迎页**: 介绍 Surf 的核心功能。
    *   **权限申请**: 引导用户授权“全盘访问权限”（Full Disk Access），以确保扫描完整性。
    *   **基础配置**: 提醒用户设置默认扫描路径、并发线程数及最小过滤大小。
    *   **服务检查**: 确认本地 `surf` server 核心状态。

**2. 用户配置设计 (User Settings):**
*   **常规设置**:
    *   默认起始扫描路径。
    *   界面语言（中/英）。
    *   主题切换（跟随系统/深色/浅色）。
*   **扫描偏好**:
    *   默认并发线程数（滑块控制）。
    *   默认最小文件过滤大小（如 100MB）。
    *   排除列表：支持用户自定义正则表达式排除特定目录（如 `Library/*`, `Containers/*`）。
*   **网络设置**:
    *   JSON-RPC 服务器地址与端口配置。

**3. 扫描记录存储 (Scan History):**
*   **自动记录**: 每次完成的扫描任务自动记录至“历史记录”列表。
*   **记录详情**: 包含扫描时间、目标路径、文件总数、总占用大小。
*   **快捷回溯**: 用户可以点击历史记录快速重新扫描同一路径，或查看上一次的扫描快照（若支持快照功能）。

**UI/UX 设计规范:**
1.  **主界面 (Main Dashboard)**:
    *   **侧边栏**: 收藏的扫描路径、最近扫描记录、设置入口。
    *   **顶部栏**: 当前扫描路径选择器、全局搜索框、扫描控制按钮（开始/暂停/停止）。
    *   **中央视图**: 
        *   **Treemap 视图**: 使用不同大小的方块展示文件/目录占用情况，颜色深度代表文件类型或修改时间。
        *   **列表视图**: 传统的层级列表，支持按列排序（名称、大小、最后修改时间）。
2.  **交互功能 (Interactions)**:
    *   **悬停展示**: 鼠标悬停在 Treemap 方块上显示完整路径和精确大小。
    *   **深度下钻**: 点击目录方块进入该目录的详细 Treemap。
    *   **快捷操作**: 右键菜单支持：
        *   `Reveal in Finder` (在访达中显示)
        *   `Move to Trash` (移至废纸篓)
        *   `Copy Path` (复制路径)
3.  **实时反馈**:
    *   扫描时，底部状态栏显示实时速度、已扫描文件数和剩余空间预测。
    *   使用平滑的动画效果展示目录大小的动态增长。

*   **集成方式**: 
    *   GUI 程序可以自动启动本地 `surf` server 进程，也可以连接到远程已存在的 server。

### 3.3 数据分析与可视化
*   **分层视图**: 以树状结构展示目录大小，支持点击下钻。
*   **文件类型分布**: 统计不同扩展名（如 .log, .mp4, .node_modules）的总占用。
*   **大文件排行榜**: 快速列出占用空间最大的 Top N 文件。
*   **时间维度分析**: 识别“陈旧文件”（长时间未访问或修改的文件）。

### 3.4 交互与输出
*   **TUI (终端 UI) 交互**: 类似于 `ncdu`，支持键盘操作进行目录导航和文件删除。
*   **结构化导出**: 支持将扫描结果导出为 JSON, CSV 或 HTML 报告。
*   **搜索与过滤**: 支持按文件名、大小范围或修改时间进行实时过滤。

## 4. 命令行参数定义

| 长参数 | 短参数 | 描述 | 默认值 |
| :--- | :--- | :--- | :--- |
| `--path` | `-p` | 指定扫描的起始根目录 | `.` |
| `--threads` | `-t` | 指定并发扫描的线程数量 | 逻辑核心数 |
| `--min-size` | `-m` | 过滤文件的最小尺寸 (支持单位: B, KB, MB, GB) | `0` |
| `--limit` | `-n` | 最终结果展示的最大条目数量 | `20` |
| `--service` | `-s` | 启动 JSON-RPC 服务模式 | `false` |
| `--port` | 无 | 服务模式监听的 TCP 端口 | `1234` |
| `--host` | 无 | 服务模式监听的地址 | `127.0.0.1` |
| `--json` | 无 | 单次模式下以 JSON 格式输出结果 (默认为表格) | `false` |
| `--help` | `-h` | 显示帮助信息 | 无 |

## 5. 非功能性需求
*   **极致性能**: 针对 SSD 进行优化，最小化内存占用，确保在处理数百万文件时系统不卡顿。
*   **跨平台兼容**: 完美支持 Linux (x86/ARM) 和 macOS (Intel/Apple Silicon)。
*   **安全性**: 扫描过程中不修改任何文件数据，删除操作需二次确认。
*   **无依赖分发**: 提供单文件静态编译二进制包，无需安装额外运行时。

## 6. 技术路线
*   **后端 (Core/Server)**: Rust (Edition 2021)
    *   **并发模型**: 基于 `rayon` 或 `tokio` 实现高性能并行扫描。
    *   **通信**: 基于 `tokio` 实现轻量级 JSON-RPC 2.0 服务。
*   **图形界面 (macOS GUI)**:
    *   **框架**: **Tauri** (使用 Rust 作为后端桥接，React 作为前端界面)。
    *   **前端**: **React** + **Tailwind CSS** + **Vite**。
    *   **状态管理**: TanStack Query (用于 RPC 数据获取) 或 Zustand。
    *   **可视化**: 使用 `Recharts` 或 `D3.js` 实现磁盘占用的树状图 (Treemap) 和饼图。
*   **命令行**: 
    *   **TUI**: `ratatui` (Rust)。
    *   **CLI 解析**: `clap` (Rust)。

## 7. 未来规划 (Roadmap)
*   **云存储支持**: 扫描 S3, Google Drive 等云端存储占用。
*   **自动化清理**: 设定策略自动清理临时文件夹。
*   **磁盘健康监测**: 集成 SMART 信息显示。

## 8. 验收标准（Acceptance Criteria）

*   **CLI / 单次运行模式**
    *   在 Linux 和 macOS 上执行 `surf --path <dir>` 时，能够完成对包含至少 1M 个文件的目录的扫描，进程不崩溃，终端输出按大小降序排序的结果列表。
    *   `--threads`、`--min-size`、`--limit`、`--json` 等参数行为与文档定义一致，错误参数会给出友好的错误提示并退出非零状态码。
    *   扫描过程中可以通过 `Ctrl+C` 中断，程序在合理时间内结束且不会留下半写入的输出文件。

*   **服务模式 (JSON-RPC)**
    *   使用 `--service` 启动后，进程在默认 `127.0.0.1:1234` 监听，并符合 JSON-RPC 2.0 规范（包含 `jsonrpc`、`method`、`params`、`id` 字段）。
    *   至少提供“启动扫描”“查询进度”“获取结果”“取消任务”这几类核心方法，参数与返回结构在接口文档中有稳定定义。
    *   在高并发请求（例如同时 10 个扫描任务）下，服务保持可用且不会出现资源泄漏或明显性能退化。

*   **TUI 模式**
    *   在常见终端环境中（如 `xterm`、`iTerm2`），界面渲染正确，不出现严重错位或闪烁。
    *   支持通过键盘完成目录导航、查看文件详情以及触发删除操作；删除前有明确的二次确认提示。

*   **macOS GUI**
    *   首次启动且不存在配置文件时，自动进入 Onboarding，包含权限申请与基础配置步骤，流程可完整走通并落盘配置。
    *   用户能在 GUI 中选择任意本地路径发起扫描，看到 Treemap 与列表视图，并通过右键菜单执行“在访达中显示”“移至废纸篓”“复制路径”等操作。
    *   在扫描大目录时 GUI 保持可响应，进度状态和扫描速率有明显反馈，不出现长时间无响应（> 2 秒）的卡死感知。

*   **非功能性**
    *   在包含数百万文件的目录上扫描时，内存占用保持在可配置或文档约定的上限以内，不导致系统明显卡顿或 OOM。
    *   所有二进制发布包为单文件或附带最小运行时依赖，按文档步骤即可在目标平台直接运行。
    *   任意扫描或删除操作在出现异常（权限不足、路径不存在、磁盘只读等）时，能够给出明确的错误信息，而不会静默失败。

