# Surf 项目需求文档 (PRD)

## 1. 项目概览
**项目名称**: Surf
**目标**: 为 Linux 和 macOS 系统提供一个极速、美观且功能强大的磁盘扫描与分析工具。
**核心价值**: 帮助用户快速定位磁盘占用大户，支持多维度可视化分析，并提供清理建议。

### 1.1 范围（Scope）
- 支持对本地文件系统的只读扫描与分析，不修改文件内容本身（删除能力作为单独操作能力提供）。
- 覆盖四种主要形态：CLI、TUI、JSON-RPC 服务模式以及 macOS GUI；核心扫描与分析能力在各形态之间保持一致。
- 面向单机环境的磁盘空间分析；云存储、远程文件系统等能力仅作为未来规划的一部分。

### 1.2 非目标（Out of Scope）
- 当前版本不支持 Windows 平台。
- 当前版本不提供自动化清理策略（仅给出清理建议），自动清理归入“未来规划”。
- 不替代系统级安全/备份方案，用户删除文件前需自行确认影响范围。

## 2. 目标用户
*   **开发者**: 需要分析代码库、依赖项或构建产物占用的磁盘空间。
*   **系统管理员**: 需要快速排查服务器磁盘满额问题。
*   **普通高级用户**: 想要管理个人电脑存储空间。

## 3. 功能需求

### 3.1 核心扫描功能
*   **并发控制**: 支持通过 `--threads` (或 `-t`) 参数指定扫描线程数。默认利用所有逻辑 CPU 核心以达到最高 IO 效率。
*   **扫描过滤**: 
    *   支持 `--min-size` 指定最小过滤大小（如 `100MB`）。
    *   支持过滤掉小于设定阈值的所有文件。

### 3.2 运行模式

#### 3.2.1 单次运行模式 (One-off)
*   **交互逻辑**:
    1.  **执行中**: 终端显示动态进度条（推荐使用 `indicatif` 库），实时反馈已处理文件数和总容量。
    2.  **完成后**: 进度条自动结束，并在其下方**默认以格式化表格形式打印最终结果**。
*   **结果展示**:
    *   **排序**: 强制按文件大小降序排列。
    *   **条数限制**: 支持 `--limit` (或 `-n`) 参数控制展示的最大条目数。例如 `--limit 20` 只显示前 20 个最大的文件。

#### 3.2.2 服务模式 (Service Mode)
*   **功能描述**: 启动 JSON-RPC 服务，允许其他应用（如 GUI 程序）通过网络连接进行磁盘扫描和分析。
*   **配置选项**: 
    *   支持 `--service` (或 `-s`) 参数启动服务模式。
    *   支持 `--port` 参数指定服务监听端口（默认 1234）。
    *   支持 `--host` 参数指定服务监听地址（默认 127.0.0.1）。

#### 3.2.3 图形界面模式 (GUI Mode - macOS)

**1. 初始安装引导 (Onboarding):**
*   **初次运行检测**: 应用程序启动时检测是否存在配置文件。若不存在，进入引导流程。
*   **引导步骤**:
    *   **欢迎页**: 介绍 Surf 的核心功能。
    *   **权限申请**: 引导用户授权“全盘访问权限”（Full Disk Access），以确保扫描完整性。
    *   **基础配置**: 提醒用户设置默认扫描路径、并发线程数及最小过滤大小。
    *   **服务检查**: 确认本地 `surf` server 核心状态。

**2. 用户配置设计 (User Settings):**
*   **常规设置**:
    *   默认起始扫描路径。
    *   界面语言（中/英）。
    *   主题切换（跟随系统/深色/浅色）。
*   **扫描偏好**:
    *   默认并发线程数（滑块控制）。
    *   默认最小文件过滤大小（如 100MB）。
    *   排除列表：支持用户自定义正则表达式排除特定目录（如 `Library/*`, `Containers/*`）。
*   **网络设置**:
    *   JSON-RPC 服务器地址与端口配置。

**3. 扫描记录存储 (Scan History):**
*   **自动记录**: 每次完成的扫描任务自动记录至“历史记录”列表。
*   **记录详情**: 包含扫描时间、目标路径、文件总数、总占用大小。
*   **快捷回溯**: 用户可以点击历史记录快速重新扫描同一路径，或查看上一次的扫描快照（若支持快照功能）。

**UI/UX 设计规范:**
1.  **主界面 (Main Dashboard)**:
    *   **侧边栏**: 收藏的扫描路径、最近扫描记录、设置入口。
    *   **顶部栏**: 当前扫描路径选择器、全局搜索框、扫描控制按钮（开始/暂停/停止）。
    *   **中央视图**: 
        *   **Treemap 视图**: 使用不同大小的方块展示文件/目录占用情况，颜色深度代表文件类型或修改时间。
        *   **列表视图**: 传统的层级列表，支持按列排序（名称、大小、最后修改时间）。
2.  **交互功能 (Interactions)**:
    *   **悬停展示**: 鼠标悬停在 Treemap 方块上显示完整路径和精确大小。
    *   **深度下钻**: 点击目录方块进入该目录的详细 Treemap。
    *   **快捷操作**: 右键菜单支持：
        *   `Reveal in Finder` (在访达中显示)
        *   `Move to Trash` (移至废纸篓)
        *   `Copy Path` (复制路径)
3.  **实时反馈**:
    *   扫描时，底部状态栏显示实时速度、已扫描文件数和剩余空间预测。
    *   使用平滑的动画效果展示目录大小的动态增长。

*   **集成方式**: 
    *   GUI 程序可以自动启动本地 `surf` server 进程，也可以连接到远程已存在的 server。

### 3.3 数据分析与可视化
*   **分层视图**: 以树状结构展示目录大小，支持点击下钻。
*   **文件类型分布**: 统计不同扩展名（如 .log, .mp4, .node_modules）的总占用。
*   **大文件排行榜**: 快速列出占用空间最大的 Top N 文件。
*   **时间维度分析**: 识别“陈旧文件”（长时间未访问或修改的文件）。

### 3.4 交互与输出
*   **TUI (终端 UI) 交互**: 类似于 `ncdu`，支持键盘操作进行目录导航和文件删除。
*   **结构化导出**: 支持将扫描结果导出为 JSON, CSV 或 HTML 报告。
*   **搜索与过滤**: 支持按文件名、大小范围或修改时间进行实时过滤。

## 4. 命令行参数定义

| 长参数 | 短参数 | 描述 | 默认值 |
| :--- | :--- | :--- | :--- |
| `--path` | `-p` | 指定扫描的起始根目录 | `.` |
| `--threads` | `-t` | 指定并发扫描的线程数量 | 逻辑核心数 |
| `--min-size` | `-m` | 过滤文件的最小尺寸 (支持单位: B, KB, MB, GB) | `0` |
| `--limit` | `-n` | 最终结果展示的最大条目数量 | `20` |
| `--service` | `-s` | 启动 JSON-RPC 服务模式 | `false` |
| `--port` | 无 | 服务模式监听的 TCP 端口 | `1234` |
| `--host` | 无 | 服务模式监听的地址 | `127.0.0.1` |
| `--json` | 无 | 单次模式下以 JSON 格式输出结果 (默认为表格) | `false` |
| `--help` | `-h` | 显示帮助信息 | 无 |

## 5. 非功能性需求
*   **极致性能**: 针对 SSD 进行优化，最小化内存占用，确保在处理数百万文件时系统不卡顿。
*   **跨平台兼容**: 完美支持 Linux (x86/ARM) 和 macOS (Intel/Apple Silicon)。
*   **安全性**: 扫描过程中不修改任何文件数据，删除操作需二次确认。
*   **无依赖分发**: 提供单文件静态编译二进制包，无需安装额外运行时。

## 6. 技术路线
*   **后端 (Core/Server)**: Rust (Edition 2021)
    *   **并发模型**: 基于 `rayon` 或 `tokio` 实现高性能并行扫描。
    *   **通信**: 基于 `tokio` 实现轻量级 JSON-RPC 2.0 服务。
*   **图形界面 (macOS GUI)**:
    *   **框架**: **Tauri** (使用 Rust 作为后端桥接，React 作为前端界面)。
    *   **前端**: **React** + **Tailwind CSS** + **Vite**。
    *   **状态管理**: TanStack Query (用于 RPC 数据获取) 或 Zustand。
    *   **可视化**: 使用 `Recharts` 或 `D3.js` 实现磁盘占用的树状图 (Treemap) 和饼图。
*   **命令行**: 
    *   **TUI**: `ratatui` (Rust)。
    *   **CLI 解析**: `clap` (Rust)。

## 7. 未来规划 (Roadmap)
*   **云存储支持**: 扫描 S3, Google Drive 等云端存储占用。
*   **自动化清理**: 设定策略自动清理临时文件夹。
*   **磁盘健康监测**: 集成 SMART 信息显示。

## 8. 验收标准（Acceptance Criteria）

*   **CLI / 单次运行模式**
    *   在 Linux 和 macOS 上执行 `surf --path <dir>` 时，能够完成对包含至少 1M 个文件的目录的扫描，进程不崩溃，终端输出按大小降序排序的结果列表。
    *   `--threads`、`--min-size`、`--limit`、`--json` 等参数行为与文档定义一致，错误参数会给出友好的错误提示并退出非零状态码。
    *   扫描过程中可以通过 `Ctrl+C` 中断，程序在合理时间内结束且不会留下半写入的输出文件。

*   **服务模式 (JSON-RPC)**
    *   使用 `--service` 启动后，进程在默认 `127.0.0.1:1234` 监听，并符合 JSON-RPC 2.0 规范（包含 `jsonrpc`、`method`、`params`、`id` 字段）。
    *   至少提供“启动扫描”“查询进度”“获取结果”“取消任务”这几类核心方法，参数与返回结构在接口文档中有稳定定义。
    *   在高并发请求（例如同时 10 个扫描任务）下，服务保持可用且不会出现资源泄漏或明显性能退化。

*   **TUI 模式**
    *   在常见终端环境中（如 `xterm`、`iTerm2`），界面渲染正确，不出现严重错位或闪烁。
    *   支持通过键盘完成目录导航、查看文件详情以及触发删除操作；删除前有明确的二次确认提示。

*   **macOS GUI**
    *   首次启动且不存在配置文件时，自动进入 Onboarding，包含权限申请与基础配置步骤，流程可完整走通并落盘配置。
    *   用户能在 GUI 中选择任意本地路径发起扫描，看到 Treemap 与列表视图，并通过右键菜单执行“在访达中显示”“移至废纸篓”“复制路径”等操作。
    *   在扫描大目录时 GUI 保持可响应，进度状态和扫描速率有明显反馈，不出现长时间无响应（> 2 秒）的卡死感知。

*   **非功能性**
    *   在包含数百万文件的目录上扫描时，内存占用保持在可配置或文档约定的上限以内，不导致系统明显卡顿或 OOM。
    *   所有二进制发布包为单文件或附带最小运行时依赖，按文档步骤即可在目标平台直接运行。
    *   任意扫描或删除操作在出现异常（权限不足、路径不存在、磁盘只读等）时，能够给出明确的错误信息，而不会静默失败。

## 9. User Stories（迭代拆解草案）

### 9.1 CLI 单次运行模式（One-off）

#### 9.1.1 CLI-ONEOFF-001 基础扫描与表格输出

- id: `CLI-ONEOFF-001`
- title: 在 CLI 中对指定目录进行单次扫描并输出按大小排序的结果表格
- status: `pending`
- description: 作为一名使用 Surf 的开发者或运维，我希望在终端中运行 `surf --path <dir>` 进行单次扫描，在看到实时进度反馈后，最终获得一份按文件/目录大小降序排序、条数可控的结果表格，以便快速定位空间占用大户。
- acceptance_criteria:
  - 在 Linux 和 macOS 上，执行 `surf --path <dir>` 时，终端在扫描过程中展示动态进度条，至少包含已扫描文件数与已扫描总大小等信息。
  - 扫描完成后，进度条自动结束，并在其下方输出格式化表格结果，表格内容按文件/目录大小降序排列。
  - 未显式指定 `--limit` 时，默认只展示前 20 条记录；指定 `--limit N` 时，展示条目数不超过 N。
  - 对不存在或不可访问的路径（例如权限不足）给出清晰错误信息，并以非零状态码退出，不输出误导性的空表格。

#### 9.1.2 CLI-ONEOFF-002 并发与最小文件大小过滤

- id: `CLI-ONEOFF-002`
- title: 用户可以通过参数控制扫描并发度和最小文件大小过滤
- status: `pending`
- description: 作为希望在不同机器和目录上优化扫描性能的用户，我希望通过 `--threads` 和 `--min-size` 参数控制扫描的并发度以及结果中出现的最小文件大小，从而在保证结果可用性的前提下缩短扫描时间、减少无关小文件干扰。
- acceptance_criteria:
  - 运行 `surf --path <dir> --threads N`（N 为合法正整数）时，程序按约定并发度启动扫描，不出现明显退化（例如设置更高并发却显著变慢或卡死）。
  - 在同一测试目录上，对比不加 `--min-size` 与加上 `--min-size 100MB` 的结果，后者的结果表中不包含任何大小小于 100MB 的文件/目录。
  - 对于非法的 `--threads` 或 `--min-size` 参数值（如 0、负数或无法解析的单位），程序给出明确错误提示并以非零状态码退出，不进入扫描过程。
  - 使用 `--threads`、`--min-size` 与 `--limit` 组合时，结果仍然按大小降序排序且条数限制与过滤逻辑符合预期。

#### 9.1.3 CLI-ONEOFF-003 JSON 结构化输出

- id: `CLI-ONEOFF-003`
- title: 用户可以在单次运行模式下以 JSON 格式获取扫描结果
- status: `in_progress`
- description: 作为希望将 Surf 扫描结果接入其他自动化工具链的用户，我希望在单次运行模式下通过 `--json` 参数获取结构化 JSON 输出，而不是表格文本，以便在脚本或 CI/CD 流水线中解析和进一步处理结果。
- acceptance_criteria:
  - 运行 `surf --path <dir> --json` 时，标准输出为合法的 JSON 文本，能够被常见 JSON 解析器无错误解析。
  - JSON 输出中至少包含：被扫描根路径、每个结果条目的完整路径、大小（带单位或统一单位字段）、文件类型或目录标识，以及与 `--limit`、`--min-size` 等参数一致的过滤/截断结果。
  - 在 `--json` 模式下，程序的退出码语义与表格模式保持一致：正常完成为 0，参数错误或严重异常为非零。
  - 对于错误参数组合（例如不支持的标志），仍然打印清晰错误信息到标准错误输出，并避免输出部分或不完整的 JSON 结构。
  - impl_notes (iteration 2 / dev-cli-tui):
    - `workspaces/dev-cli-tui/surf-cli/src/main.rs:59` 定义了 `JsonEntry`/`JsonOutput` 结构，当前 JSON 根对象包含 `root` 与 `entries` 数组，条目字段为 `path`、`size`、`is_dir`（扫描器目前仅返回文件，目录条目暂不支持）。
    - `workspaces/dev-cli-tui/surf-cli/tests/integration.rs:9` 起，包含以下端到端用例：
      - `--path <temp_dir> --min-size 10 --limit 1 --json` 成功路径，验证 stdout 为合法 JSON、`root` 与临时目录一致，`entries` 长度不超过 `limit`、`size >= min-size` 且 `is_dir == false`。
      - `--json` 模式下非法 `--min-size`、非法 `--threads`、不存在路径等错误场景，均保证进程非零退出、stdout 保持空白、错误信息仅输出到 stderr；非 `--json` 模式下非法 `--min-size` 行为与之保持一致。
  - remaining_todos:
    - 本轮（Ralph iteration 8）在仓库根目录尝试执行：`cargo test -p surf-core --offline`、`cargo test -p surf-cli --offline` 以及 `cargo test -p surf-core`，均因无法从 `https://github.com/rust-lang/crates.io-index` 获取 `rayon` 依赖而失败；在线模式下多次重试时出现 `failed to connect to github.com: Connection timed out`，确认当前 Ralph 运行环境无可用 crates.io 网络访问或本地缓存。
    - 受上述限制影响，`surf-core` 与 `surf-cli` 已经就绪的单元测试与端到端集成测试（包括 `workspaces/dev-core-scanner/surf-core/tests/basic_scan.rs` 与 `workspaces/dev-cli-tui/surf-cli/tests/integration.rs`）目前只能在具备网络或完整依赖缓存的 CI / 开发机上执行；建议在该类环境中运行 `cargo test --workspace` 或至少 `cargo test -p surf-core` / `cargo test -p surf-cli` 以完成对 CLI-ONEOFF-003 的自动化验收覆盖。
    - 在 CI 流水线中启用并稳定上述 `workspaces/dev-cli-tui/surf-cli/tests/integration.rs` 用例，作为回归保护，避免未来改动破坏 `--json` 模式下的 stdout/stderr 语义。

### 9.2 服务模式（示例）

#### 9.2.1 SVC-JSONRPC-001 启动本地 JSON-RPC 服务并保持可用

- id: `SVC-JSONRPC-001`
- title: 用户可以在本机启动 Surf JSON-RPC 服务并通过网络访问
- status: `pending`
- description: 作为计划开发 GUI 或集成其他工具的开发者，我希望通过 `surf --service` 在本机启动一个 JSON-RPC 服务进程，并可通过 `--host` 与 `--port` 配置监听地址与端口，从而在不每次重新启动扫描进程的情况下，复用同一服务进行多次扫描请求。
- acceptance_criteria:
  - 运行 `surf --service` 后，进程在默认 `127.0.0.1:1234` 上监听，且符合 JSON-RPC 2.0 协议基本格式（包含 `jsonrpc`、`method`、`params`、`id` 字段）。
  - 使用 `--host` 与 `--port` 参数可以成功修改监听地址与端口，配置非法地址或端口时给出清晰错误提示并退出。
  - 在同一进程中，连续发送多次“启动扫描”“查询进度”“获取结果”请求时，服务保持稳定，不出现崩溃或资源泄漏迹象。
  - 在无请求时，服务进程保持空闲且资源占用在可接受范围内，支持通过常规信号（例如 `Ctrl+C`）优雅退出。

### 9.3 待确认问题

- 【CLI 单次运行】在使用 `--json` 输出时，终端是否仍需展示进度条？若展示，是否有对 JSON 消费方不会造成干扰的输出分流约定（例如进度仅输出到 stderr）？
  - 【设计决策】如无特别说明，CLI 在 `--json` 模式下仍允许展示进度条，但进度条和日志统一输出到 stderr，stdout 仅在扫描成功时一次性输出完整 JSON；扫描失败、参数错误或被中断（包括 Ctrl+C）时，stdout 不输出任何 JSON，仅在 stderr 输出错误说明，并以非零状态码退出。

- 【CLI 单次运行】当用户通过 `Ctrl+C` 中断扫描时，是否需要输出部分结果（例如已扫描结果的 JSON 或表格）？当前 PRD 仅要求“合理时间内结束且不留下半写入的输出文件”，但对标准输出的行为尚未明确。
  - 【设计决策】如无特别说明，CLI 在 JSON 和表格模式下均不输出部分结果；当用户通过 Ctrl+C 中断扫描时，程序清理进度条，在 stderr 输出“用户中断”提示，并以 130 等非零退出码退出，保证不会产生半写入的输出文件或结构化结果。后续如对“部分结果输出”有强需求，可在未来迭代中单独立项扩展相应语义与行为。
