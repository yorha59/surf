# 架构设计文档

## 1. 架构目标
- **架构要解决的问题**：为 Linux 和 macOS 系统提供一个极速、美观且功能强大的磁盘扫描与分析工具，帮助用户快速定位磁盘占用大户，支持多维度可视化分析，并提供清理建议。
- **设计原则**：
  - 高性能：利用并发技术最大化 IO 效率，针对 SSD 进行优化
  - 可扩展性：模块化设计，支持多种运行模式和输出格式
  - 跨平台兼容：完美支持 Linux (x86/ARM) 和 macOS (Intel/Apple Silicon)
  - 安全性：扫描过程中不修改任何文件数据，删除操作需二次确认
  - 无依赖分发：提供单文件静态编译二进制包
- **约束条件**：
  - 最小化内存占用，确保在处理数百万文件时系统不卡顿
  - 支持 JSON-RPC 2.0 协议
  - 提供 TUI 和 GUI 两种交互方式

## 2. 技术栈
- **后端语言与框架**：Rust (Edition 2021)，使用 rayon/tokio 实现并发，clap 处理命令行参数
- **前端技术**：React + Tailwind CSS + Vite，使用 Tauri 作为桌面应用框架
- **数据存储**：SQLite (通过 rusqlite 或 sqlx) 存储配置和历史记录
- **部署方式**：
  - 命令行工具：单文件静态编译二进制
  - GUI 应用：通过 Tauri 打包为 macOS 应用
- **第三方依赖**：
  - 终端进度条：indicatif
  - TUI：ratatui
  - JSON-RPC：基于 tokio 实现
  - 前端可视化：Recharts 或 D3.js
  - 状态管理：TanStack Query 或 Zustand
  - 命令行解析：clap
  - 序列化：serde, serde_json
  - CSV 导出：csv
  - HTML 转义：html-escape
  - 终端输入：termion

## 3. 整体架构概览
- **系统整体结构**：
  - 核心扫描引擎 (Scanner Engine)：负责并发扫描磁盘，收集文件元数据
  - 数据聚合层 (Data Aggregator)：处理和存储扫描结果
  - 服务层 (Service Layer)：提供 JSON-RPC 接口
  - 命令行界面 (CLI/TUI)：提供终端交互
  - 图形界面 (GUI)：基于 Tauri + React 的桌面应用
- **模块关系**：
  - 核心扫描引擎是基础，被服务层、CLI 和 GUI 共享
  - 服务层封装扫描引擎，提供网络接口
  - CLI 和 GUI 作为不同的前端，通过不同方式与核心功能交互

## 4. 模块拆分设计

### 4.1 核心扫描引擎 (Scanner Engine)
- **模块职责**：
  - 并发扫描磁盘文件系统
  - 收集文件元数据（路径、大小、修改时间等）
  - 处理权限不足的目录
  - 支持过滤规则
- **模块边界**：
  - 负责：文件系统扫描、元数据收集、过滤处理
  - 不负责：结果展示、持久化存储
- **对外提供的能力**：
  - `scan(path, min_size, threads)`：启动扫描并返回结果
  - `status()`：获取扫描进度和状态
- **依赖哪些模块**：
  - 标准库：`std::fs`, `std::thread`
  - 第三方：`rayon` 或 `tokio` 用于并发
- **推荐负责人角色**：后端工程师

### 4.2 数据聚合层 (Data Aggregator)
- **模块职责**：
  - 内存中维护目录树结构
  - 汇总和排序扫描结果
  - 提供数据查询接口
- **模块边界**：
  - 负责：数据结构管理、结果汇总、排序
  - 不负责：文件系统扫描、结果展示
- **对外提供的能力**：
  - `get_tree(path)`：获取指定路径的目录树
  - `get_top_files(limit)`：获取按大小排序的前 N 个文件
  - `get_file_type_distribution()`：获取文件类型分布
- **依赖哪些模块**：
  - 核心扫描引擎的扫描结果
- **推荐负责人角色**：后端工程师

### 4.3 服务层 (Service Layer)
- **模块职责**：
  - 实现 JSON-RPC 2.0 协议
  - 管理扫描任务的生命周期
  - 处理并发请求
- **模块边界**：
  - 负责：网络通信、任务管理、协议实现
  - 不负责：文件系统扫描、数据存储
- **对外提供的能力**：
  - JSON-RPC 接口：`Surf.Scan`, `Surf.Status`, `Surf.GetResults`
- **依赖哪些模块**：
  - 核心扫描引擎
  - 数据聚合层
  - 第三方：`tokio` 用于网络通信
- **推荐负责人角色**：后端工程师

### 4.4 命令行界面 (CLI/TUI)
- **模块职责**：
  - 解析命令行参数
  - 显示扫描进度
  - 展示扫描结果
  - 提供 TUI 交互
- **模块边界**：
  - 负责：用户输入处理、结果展示、终端交互
  - 不负责：文件系统扫描、数据存储
- **对外提供的能力**：
  - 命令行工具：`surf [options] [path]`
  - TUI 交互：键盘导航、文件操作
- **依赖哪些模块**：
  - 核心扫描引擎
  - 数据聚合层
  - 第三方：`clap` 用于参数解析，`indicatif` 用于进度条，`ratatui` 用于 TUI
- **推荐负责人角色**：后端工程师

### 4.5 图形界面层 (GUI Layer)
- **模块职责**：
  - 提供 macOS 桌面应用界面
  - 管理用户配置
  - 展示扫描结果和可视化
  - 提供文件操作功能
- **模块边界**：
  - 负责：用户界面、交互逻辑、可视化展示
  - 不负责：文件系统扫描、网络通信
- **对外提供的能力**：
  - macOS 应用：Surf.app
  - 图形化扫描控制和结果展示
- **依赖哪些模块**：
  - 服务层（通过 JSON-RPC）
  - 第三方：Tauri, React, Tailwind CSS, Recharts/D3.js
- **推荐负责人角色**：前端工程师

### 4.6 持久化存储层 (Persistence Layer)
- **模块职责**：
  - 存储用户配置
  - 记录扫描历史
  - 管理应用状态
- **模块边界**：
  - 负责：数据持久化、配置管理
  - 不负责：文件系统扫描、结果展示
- **对外提供的能力**：
  - `save_config(config)`：保存用户配置
  - `load_config()`：加载用户配置
  - `save_scan_history(history)`：保存扫描历史
  - `load_scan_history()`：加载扫描历史
- **依赖哪些模块**：
  - 第三方：`rusqlite` 或 `sqlx` 用于 SQLite 操作
- **推荐负责人角色**：后端工程师

## 5. 核心数据流

### 5.1 单次运行模式数据流
1. 用户执行 `surf --path /path/to/scan --min-size 100MB`
2. CLI 模块解析参数，调用核心扫描引擎的 `scan()` 方法
3. 核心扫描引擎启动并发扫描，定期更新进度
4. 扫描完成后，数据聚合层汇总和排序结果
5. CLI 模块以表格形式展示结果

### 5.2 服务模式数据流
1. 用户执行 `surf --service --port 1234` 启动服务
2. 客户端通过 JSON-RPC 调用 `Surf.Scan` 方法
3. 服务层接收请求，调用核心扫描引擎的 `scan()` 方法
4. 核心扫描引擎启动并发扫描
5. 客户端通过 `Surf.Status` 方法查询进度
6. 扫描完成后，客户端通过 `Surf.GetResults` 方法获取结果

### 5.3 GUI 模式数据流
1. 用户打开 Surf.app，配置扫描参数
2. GUI 层通过 Tauri 调用后端桥接函数
3. 后端桥接函数启动服务模式（如果未启动）并发送 JSON-RPC 请求
4. 服务层处理请求，调用核心扫描引擎
5. 核心扫描引擎启动并发扫描
6. GUI 层通过 React Query 管理扫描状态和结果
7. 扫描完成后，GUI 层展示结果和可视化

## 6. 风险与待确认问题

### 6.1 技术风险
- **性能风险**：处理数百万文件时的内存占用和扫描速度
- **权限风险**：在 macOS 上获取全盘访问权限的稳定性
- **并发风险**：多线程扫描可能导致系统 IO 压力过大

### 6.2 待确认问题
- **GUI 跨平台支持**：PRD 中只提到了 macOS GUI，是否需要支持 Linux GUI？
- **扫描快照功能**：PRD 中提到了“查看上一次的扫描快照”，需要确认具体实现方式
- **文件删除操作**：需要确认在不同平台上的实现方式和安全性

### 6.3 潜在风险
- **系统资源占用**：高并发扫描可能影响系统性能
- **网络安全**：服务模式下的 JSON-RPC 接口可能存在安全风险
- **依赖库兼容性**：第三方库的版本更新可能导致兼容性问题