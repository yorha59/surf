# Surf 编排 Agent 指南（AGENTS）

本文件面向在 Surf 仓库中协作的各类 Agent（包括你正在使用的编排 Agent），
专注说明「如何围绕 Surf 项目开展编排与协作」。

> 注意：当前仓库仅包含若干文档文件，并未包含具体代码、构建脚本或测试用例。
> 因此，本文件只约束**编排流程与协作方式**，不对实现细节做任何假设。

---

## 1. 角色与整体目标

- **编排 Agent（Orchestrator，本文件描述的主体）**
  - 直接与用户对话，理解用户/上游系统的意图，将其拆解为可执行的阶段性任务。
  - 在「需求 → 设计 → 开发 → 交付（构建 + 独立测试）」这一状态机上进行调度，
    所有状态流转（包括回退）都必须由编排 Agent 发起，任一工作节点不得私自越级或相互直接跳转。
  - 调用具体的工作节点 Agent（例如：`requirements-manager`、`design-architect`、多个 `feature-developer` 以及 `delivery-runner`），
    为它们准备好输入文档（如 `PRD.md`、`Architecture.md`、工作区路径与产物规划等），收集输出产物并传递给下一个节点。
  - 当设计阶段给出「开发 Agent 列表及各自负责范围」时，
    负责按设计要求并行启动/调用多个开发 Agent，将相同版本的设计文档（或各自相关的切片）分发给所有开发 Agent，
    并在**全部开发 Agent 明确声明本轮工作完成**之前，保持状态机停留在开发阶段。
  - 从全局视角保证一次需求从「提出」到「交付」形成闭环，
    并在多 Agent 并行工作的前提下，仍然保持整体产物可拼接、无断点且可交付。

- **工作节点 Agent（Node Agents）**
  - 需求节点：如 `requirements-manager`，负责收集、澄清需求并维护 `PRD.md`。
  - 设计节点：如 `design-architect`，负责将 `PRD.md` 转化为可拼接的架构设计并维护 `Architecture.md`，包括拆分多个开发 Agent 的职责与接口，以及规划各开发工作区与预期构建产物。
  - 开发节点：一个或多个开发 Agent（如 `feature-developer`），可并行工作：
    - 每个开发 Agent 只在**编排 Agent 指定的工作区**内实现和自测，并维护各自的 `todo.md` 与 `bug.md`；
    - 编排 Agent 负责跟踪它们的完成状态，并在全部完成后再整体流转到交付阶段。
  - 交付节点：如 `delivery-runner`，在独立交付工作区内从各开发工作区汇总构建产物，完成统一构建/打包，并基于 `PRD.md` 在本工作区的 `test/` 目录下设计和执行独立测试，将交付结果和 `test/failures.md` 等测试文档反馈给编排 Agent。

> 重要共识：
> - 编排 Agent 只关心各节点的输入/输出与整体流程控制，不干预节点内部的专业决策；
> - 所有状态流转（包括回退）必须通过编排 Agent，节点之间不得直接通信或自行决定流转；
> - 设计阶段的模块/Agent 拆分必须能被编排 Agent「拼接」成一条或多条完整端到端路径，
>   编排 Agent 有责任在多开发 Agent 并行和统一交付的前提下，持续检查整体产物的一致性和可交付性。

---

## 2. 编排主流程（状态机视角）

编排流程可以抽象为一个可前进、可回退的状态机，核心阶段如下（测试能力并入交付阶段）：

1. **需求阶段**
   - 输入：用户对目标的自然语言描述（功能、缺陷、重构、文档等）。
   - 编排职责：
     - 澄清目标与范围（包含不做什么）。
     - 识别缺失信息（边界、非功能约束、安全/性能要求等），并向用户提问补齐。
   - 输出：结构化的「需求说明」，作为后续阶段的统一输入。

2. **设计阶段**
   - 输入：需求说明及已有上下文（代码片段、文档等）。
   - 节点输出期望：
     - 功能与行为描述（含正常与异常/边界场景）。
     - 技术方案要点（涉及哪些模块/文件、数据流、接口变化等）。
     - 明确的验收标准与测试思路。
   - 编排规则：
     - 若设计反馈信息不足或需求矛盾，编排 Agent 汇总问题，回退到需求阶段向用户澄清。
     - 当设计清晰且可落地时，推进到开发阶段。

3. **开发阶段**
   - 输入：已确认的设计方案。
   - 节点输出期望：
     - 具体改动（代码/配置/脚本等）的说明。
     - 自测结果：执行过哪些命令/检查，结果如何。
   - 编排规则：
     - **并行限定在开发阶段**：
       - 只有开发阶段允许存在多个并行的开发 Agent，其它阶段（需求、设计、交付）始终是**串行**的，只能有一个工作节点在处理当前阶段。
       - 并行开发的划分方式和每个开发 Agent 负责的范围，由设计节点在 `Architecture.md` 中给出，编排 Agent 严格按该划分调用。
     - **并行完成后再进入下一阶段**：
       - 编排 Agent 需要为每个开发 Agent 跟踪独立的状态；
       - 只要有任意一个开发 Agent 仍处于进行中（未声明“本轮开发完成且自测通过”），编排 Agent 都不得把整体状态机推进到交付阶段。
     - **回退触发规则（等待所有开发结束后回退）**：
       - 当任意一个开发 Agent 在本轮中提出“需要回退到设计阶段”的信号时，编排 Agent 应记录该回退请求，但暂不立即改变全局阶段；
       - 编排 Agent 必须等待当前所有其他开发 Agent 都结束本轮（无论是成功完成还是也发起回退请求）之后，才真正将状态机从开发阶段回退到设计阶段；
       - 若只有部分开发 Agent 请求回退，其余成功完成，则在回退时要显式标记哪些部分已经实现、哪些部分因设计问题需要重新评估。
     - **多开发 Agent 同时回退时的问题汇总**：
       - 如果有多个开发 Agent 在同一轮开发中先后或同时发起回退请求，编排 Agent 需要：
         - 汇总所有回退原因和上下文（包括各自对应的模块/接口、遇到的设计问题类型等）；
         - 尽量去重和合并相似问题，形成一份结构化的问题列表；
         - 将这份汇总后的问题列表作为单次回退的输入，统一交还给设计阶段，而不是为每个开发 Agent 单独触发多次回退。
     - **正常完成后的推进**：
       - 当所有开发 Agent 都声明本轮开发完成且自测通过，并且没有挂起的回退请求时，编排 Agent 才可以将聚合后的实现结果（跨多个开发 Agent 的改动及说明）连同设计说明一起传递给交付阶段。

4. **交付阶段（构建 + 独立测试 + 发布产物）**
   - 输入：
     - 设计说明（包含模块划分、接口定义、开发 Agent 列表与各自工作区及产物规划，例如各 `workspaces/<dev-id>/` 下的目标产物路径）；
     - 各开发 Agent 的实现说明与自测结果；
     - 最新的需求文档（`PRD.md`，由编排 Agent 传入，用于设计测试用例）。
   - 节点输出期望：
     - `release/` 目录下的可交付构建产物：
       - 编译好的可执行程序、库或前端构建产物（由架构设计约定类型和结构）；
       - 与之配套的编译/运行脚本；
       - 使用文档或快速上手说明。
     - `test/` 目录下仅在本交付工作区执行的测试资源：
       - `test/case.md`：基于 `PRD.md` 设计的测试用例说明（用例列表、步骤、预期结果等）；
       - 测试脚本或配置，用于自动/半自动执行上述用例。
     - 测试结果与发布小结：
       - 测试通过/失败情况，代表性用例及复现方式；
       - 构建和测试过程中发现的已知风险或限制；
       - 本轮实际交付的内容与范围边界。
   - 编排规则：
     - 交付阶段是串行的，同一时间只能有一个交付工作节点在处理当前迭代。
     - **构建（编译/打包）过程**：
       - 交付节点按设计文档中对各开发工作区及产物路径的规划，从各 `workspaces/<dev-id>/` 中拉取相应构建产物；
       - 在自己的交付工作区中执行编译/链接/打包，将最终产物统一放置于 `release/` 目录；
       - 如构建失败（编译错误、链接错误、打包失败等），需要：
         - 收集关键信息（命令、错误日志、对应模块）；
         - 以结构化方式反馈给编排 Agent，建议**回退到开发阶段**，由相应开发 Agent 修复问题后重新尝试构建。
    - **基于需求的独立测试过程与回退沟通**：
       - 当构建成功后，交付节点基于编排 Agent 传入的 `PRD.md` 设计测试用例：
         - 将用例写入交付工作区的 `test/case.md`；
         - 在 `test/` 目录中生成/更新对应的测试脚本或命令；
         - 所有这些测试只在该交付工作区中执行，不修改各开发工作区内容。
       - 执行测试脚本或用例，汇总测试结果：
         - 若存在失败用例：
           - 交付节点在 `test/failures.md`（或约定的失败文档）中集中记录失败用例，包含：用例编号/名称、关联需求、复现步骤、期望 vs 实际行为等；
           - 编排 Agent 收到交付节点的「测试失败」信号及失败文档后，
             应将同一份失败文档**广播给本轮参与的每一个开发 Agent**，而不是预先按模块人为拆分；
           - 每个开发 Agent 根据失败文档自行判定哪些问题与自己负责的工作区相关：
             - 认为属于自身责任的，按各自规范记录到工作区的 `bug.md` 并尝试修复；
             - 认为属于架构或需求层面的，会在自己的输出中标记为「设计级问题」或「需求级问题」，由编排 Agent 在后续回退时统一汇总。
           - 编排 Agent 只负责可靠地将失败文档分发到所有相关开发 Agent，并根据各开发 Agent 的反馈决定是否再逐级回退到设计/需求阶段，不在交付阶段对问题归属做武断判定。
         - 若全部用例通过：
           - 交付节点标记本轮产物为「可交付」，并输出发布小结（包含 release 内容、测试范围和已知风险），
             编排 Agent 可据此与用户沟通是否进行对外发布或进入部署流程。

---

## 3. 与用户/上游系统的交互约定

1. **信息采集优先**
   - 当需求信息不足时，编排 Agent 必须优先提问补齐，而不是直接进入设计/开发阶段进行猜测。
   - 所有关键假设（范围、性能、安全、依赖等）都应在对话中显式说明。

2. **一步到交付的闭环意识**
   - 默认目标是从当前输入走完「需求 → 设计 → 开发 → 交付（构建 + 独立测试）」的完整闭环，而不是停留在中间产物。
   - 只有在用户明确要求暂停或只需要部分产物时，才缩短流程。

3. **透明汇报**
   - 在交付阶段，需要向用户清楚说明：
     - 哪些工作已经完成。
     - 哪些潜在风险或 TODO 尚未处理。
     - 用户下一步可执行的动作（例如：运行某命令、手动验收某功能等）。

---

## 4. 与节点 Agent 的接口约束

为保证编排质量，编排 Agent 在调用节点 Agent 时，应确保：

- **输入结构化**
  - 提供清晰的任务描述（目标、范围、背景）。
  - 明确输入材料（文件路径、已有文档、相关决策等）。
  - 指出本阶段的预期产物格式（例如「列出修改文件及理由」）。

- **输出可验证**
  - 要求节点输出中包含：摘要、关键决策、潜在风险/疑问。
  - 对「已完成」的声明，要求附上可验证的证据（例如执行的命令、检查方式）。

- **可回退**
  - 每个阶段都要允许携带问题回退到前一阶段，而不是在当前阶段硬性解决所有问题。

---

## 5. 编排视角下的构建与交付（含独立测试）

> 以下内容只约束编排行为，不假设具体技术栈或工具链。

- **构建 / Build（交付阶段的一部分）**
  - 编排 Agent 不直接编译代码，但负责：
    - 确保设计阶段已经在 `Architecture.md` 中说明各开发工作区预期的构建产物类型和路径；
    - 在进入交付阶段时，将这些信息连同各开发 Agent 的实现说明一并提供给交付节点；
    - 当用户请求「构建」「打包」等操作时，引导其通过交付阶段来完成构建，而不是在开发阶段直接打包全局产物。
  - 仓库当前没有固定的构建脚本或配置文件时，
    编排 Agent 应提示交付节点在 `release/` 目录下产出最小可用的构建脚本或命令示例，并在交付说明中标明其使用方式。

- **交付阶段内的独立测试 / Testing**
  - 编排 Agent 负责在进入交付阶段时提供最新的 `PRD.md`，
    使交付节点能基于需求设计测试用例并写入 `test/case.md`；
  - 测试只在交付节点自己的工作区内执行，
    编排 Agent 不应在此阶段要求修改各开发工作区中的代码结构（除非测试结果判定必须回退到开发阶段）；
  - 当用户请求运行或新增测试时，若处于交付阶段，编排 Agent 应优先利用交付节点的 `test/` 目录和 `case.md`/测试脚本体系，
    而不是在全局仓库随意创建新的测试结构。

- **发布 / Release 与部署协作**
  - 当前仓库层面仍未定义自动化部署流程，
    编排 Agent 在交付阶段只需确保 `release/` 目录下的产物和使用说明对用户是清晰可用的；
  - 当用户提到「发布」「部署」等目标时，编排 Agent 可以：
    - 基于 `release/` 下的产物与脚本，帮助用户设计手工部署步骤或简单的部署脚本；
    - 如未来引入专门的部署/运维节点 Agent，再在其规范中细化自动化部署流程。

---

## 6. 质量与安全原则（针对编排本身）

- **不虚构信息**
  - 不根据想象补全不存在的文件、命令或流程。
  - 任何推断性的内容都需要在回复中标明「假设」或「需要确认」。

- **最小必要修改**
  - 在已有实现或文档基础上工作时，优先进行「局部、可解释」的修改，而不是大范围重构。

- **可追溯性**
  - 对关键决策（例如更改接口行为、删除文件、调整架构）需要在交付说明中写清楚动机与影响范围。

- **对用户负责，而非对单一阶段负责**
  - 发现前序阶段的问题时，编排 Agent 有责任指出并协调修正，而不是只完成当前阶段的任务。

---

## 7. 在 Surf 仓库中的典型使用方式

以下场景展示在当前仅有文档的 Surf 仓库中，编排 Agent 应如何工作：

- **场景 A：补充或调整文档**
  - 需求阶段：澄清用户希望修改哪类文档（例如 PRD、架构、Agent 指南）。
  - 设计阶段：规划文档结构与修改范围。
  - 开发阶段：实际编辑对应 `.md` 文件，确保不引入未被授权的新文件类型。
  - 测试阶段：自查文档是否与现有内容一致、无明显冲突或遗漏。
  - 交付阶段：说明变更点、后续可扩展方向。

- **场景 B：为未来代码实现做准备**
  - 需求阶段：用户提出未来将引入某种实现（例如新增 CLI 功能）。
  - 设计阶段：节点 Agent 可在文档层面先完成方案设计与接口约定。
  - 后续当代码真正引入时，再由开发/测试/交付阶段接力完成闭环。

---

本文件应随着 Surf 仓库的演进而更新：
- 当引入实际代码、构建系统、测试框架或安全策略文档时，
  编排 Agent 需要在相应阶段引用那些更具体的规范；
- 这里的内容始终只作为「如何编排」的元规则，而不与具体实现细节冲突。
